apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: weave-gitops-app
spec:
  releaseName: weave-gitops-app
  targetNamespace: flux-system
  chart:
    spec:
      chart: charts/gitops-server
      sourceRef:
        kind: GitRepository
        name: weave-gitops
        namespace: flux-system
      version: "1.0.0"
  interval: 10m0s
  install:
    remediation:
      retries: 3
  values:
    image:
      # FIXME gitops-server -> weave-gitops-app
      repository: europe-west1-docker.pkg.dev/weave-gitops-clusters/weave-gitops/gitops-server # {"$imagepolicy": "flux-system:weave-gitops-app:name"}
      tag: 1653471626-114f198c68dda14e17f536ba63e75222b075f87c # {"$imagepolicy": "flux-system:weave-gitops-app:tag"}
    adminUser:
      create: true
      username: test-admin
      passwordHash: $2y$10$sHT5PLEDTGWSwde/DfOZveOFcjAHy5ap37s6cyV7z6i2Ca6KMygUy
    # FIXME? handle TLS @ that LB?
    additionalArgs: ["--insecure"]
    service:
      annotations:
        beta.cloud.google.com/backend-config: '{"default": "default-lb-backend-config"}'
        networking.gke.io/v1beta1.FrontendConfig: default-lb-frontend-config
    # Enable ingress (we don't set a type b/c GKE magics that)
    ingress:
      enabled: true
      annotations:
        networking.gke.io/managed-certificates: gitops-cert # must match name tls-certs.yaml
      hosts:
      - host: gitops.euw1.wego-gke.weave.works
        paths:
        - path: /*
          pathType: ImplementationSpecific # ImplementationSpecific => let the lb decide
